# =============================================================================
# Continuous Integration Workflow
# =============================================================================
#
# Runs on every push and PR to validate:
# - Swift build succeeds
# - Unit tests pass
# - Code compiles without warnings
#
# =============================================================================

name: CI

on:
  push:
    branches: [main, 'fix/**', 'feature/**']
  pull_request:
    branches: [main]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build (Debug)
        run: swift build

      - name: Build (Release)
        run: swift build -c release

      - name: Run Unit Tests
        run: |
          swift test --filter "CompleteTests" 2>&1 | tee test-output.log
          # Check for test failures
          if grep -q "Test Suite.*failed" test-output.log; then
            echo "âŒ Some tests failed"
            exit 1
          fi
          echo "âœ… All unit tests passed"

      - name: Validate Visual Test Scripts
        run: |
          # Validate bash script
          bash -n tests/visualScreenshotTesting/run-visual-tests.sh

          # Validate AppleScript modules
          for script in tests/visualScreenshotTesting/modules/*.applescript; do
            osacompile -o /dev/null "$script"
          done

          echo "âœ… All scripts valid"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”¨ Build & Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Build | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Build | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Script Validation | âœ… |" >> $GITHUB_STEP_SUMMARY
